---
title: "Getting Started with birdweather"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with birdweather}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

```{r setup}
library(birdweather)
library(dplyr)
library(ggplot2)
```

## Introduction

The `birdweather` package provides R users with easy access to acoustic bird monitoring data from the BirdWeather platform. This vignette walks through a typical workflow for downloading and analyzing BirdWeather data.

## Authentication

First, you'll need to obtain an API token from your BirdWeather account:

1. Log into [birdweather.com](https://birdweather.com)
2. Navigate to your profile settings
3. Generate an API token

Set your token in R:

```{r}
bw_set_token("your_token_here")
```

To avoid re-entering your token each session, save it to your `.Renviron` file:

```{r}
bw_set_token("your_token_here", install = TRUE)
```

After installation, restart R for the token to be available automatically.

## Finding Stations

### Your Own Stations

If you operate BirdWeather stations, retrieve them with:

```{r}
my_stations <- bw_get_my_stations()
print(my_stations)
```

### Public Stations

To explore public stations:

```{r}
# Get first 100 stations
stations <- bw_get_stations(limit = 100)

# Get specific station by ID
station <- bw_get_stations(station_id = "12345")
```

## Downloading Detection Data

The `bw_get_detections()` function is the workhorse of the package. It handles pagination automatically and returns a clean tibble.

### Basic Usage

```{r}
# Download all detections from a station
detections <- bw_get_detections(
  station_id = my_stations$id[1]
)

# View structure
glimpse(detections)
```

### Date Filtering

```{r}
# Get detections for specific date range
detections_2024 <- bw_get_detections(
  station_id = my_stations$id[1],
  start_date = "2024-01-01",
  end_date = "2024-12-31"
)

# Just one month
june_detections <- bw_get_detections(
  station_id = my_stations$id[1],
  start_date = "2024-06-01",
  end_date = "2024-06-30"
)
```

### Confidence Filtering

Machine learning detections include a confidence score. Filter for high-quality detections:

```{r}
# Only high-confidence detections
high_conf_detections <- bw_get_detections(
  station_id = my_stations$id[1],
  start_date = "2024-01-01",
  end_date = "2024-12-31",
  min_confidence = 0.8
)
```

### Species Filtering

```{r}
# Get species list
species <- bw_get_species()

# Find American Robin
robin <- species %>% 
  filter(commonName == "American Robin")

# Get only robin detections
robin_detections <- bw_get_detections(
  station_id = my_stations$id[1],
  species_id = robin$id[1],
  start_date = "2024-01-01",
  end_date = "2024-12-31"
)
```

### Multiple Stations

```{r}
# Download from multiple stations
multi_station <- bw_get_detections(
  station_id = c("station1", "station2", "station3"),
  start_date = "2024-01-01",
  end_date = "2024-01-31"
)
```

## Analyzing Detection Data

### Species Summaries

```{r}
# Summarize detections by species
species_summary <- bw_summarize_species(detections)
print(species_summary)

# Filter to species with at least 10 detections
common_species <- bw_summarize_species(detections, min_detections = 10)

# Top 10 most detected
top_10 <- head(species_summary, 10)
```

### Temporal Patterns

```{r}
# Daily detection counts
daily <- bw_summarize_temporal(detections, period = "day")

# Plot daily pattern
ggplot(daily, aes(x = time_period, y = n_detections)) +
  geom_line() +
  geom_smooth(method = "loam") +
  labs(title = "Daily Bird Activity",
       x = "Date", y = "Number of Detections") +
  theme_minimal()

# Weekly summaries
weekly <- bw_summarize_temporal(detections, period = "week")

# Monthly with species breakdown
monthly_species <- bw_summarize_temporal(
  detections, 
  period = "month",
  by_species = TRUE
)

# Plot top species over time
top_species <- species_summary$species_common_name[1:5]

monthly_species %>%
  filter(species_common_name %in% top_species) %>%
  ggplot(aes(x = time_period, y = n_detections, color = species_common_name)) +
  geom_line() +
  labs(title = "Monthly Detections - Top 5 Species",
       x = "Month", y = "Detections", color = "Species") +
  theme_minimal()
```

### Time of Day Analysis

```{r}
# Dawn chorus (5 AM - 9 AM)
dawn <- bw_filter_time_of_day(detections, start_hour = 5, end_hour = 9)
dawn_species <- bw_summarize_species(dawn)

# Nocturnal activity (8 PM - 6 AM)
nocturnal <- bw_filter_time_of_day(detections, start_hour = 20, end_hour = 6)
nocturnal_species <- bw_summarize_species(nocturnal)

# Compare diurnal vs nocturnal species richness
cat("Dawn species richness:", nrow(dawn_species), "\n")
cat("Nocturnal species richness:", nrow(nocturnal_species), "\n")
```

### Hourly Patterns

```{r}
# Get hourly patterns
detections <- detections %>%
  mutate(hour = lubridate::hour(timestamp))

hourly_pattern <- detections %>%
  group_by(hour) %>%
  summarise(n_detections = n(),
            n_species = n_distinct(species_id))

ggplot(hourly_pattern, aes(x = hour, y = n_detections)) +
  geom_col() +
  scale_x_continuous(breaks = 0:23) +
  labs(title = "Detection Activity by Hour",
       x = "Hour of Day", y = "Number of Detections") +
  theme_minimal()
```

## Community Ecology Analyses

### Site x Species Matrices

```{r}
# Download from multiple stations
stations_data <- bw_get_detections(
  station_id = c("station1", "station2", "station3"),
  start_date = "2024-01-01",
  end_date = "2024-12-31",
  min_confidence = 0.8
)

# Create presence/absence matrix
pa_matrix <- bw_detection_matrix(stations_data, value = "presence")

# Create abundance matrix
abundance_matrix <- bw_detection_matrix(stations_data, value = "count")

# Create mean confidence matrix
conf_matrix <- bw_detection_matrix(stations_data, value = "confidence")
```

### Diversity Indices

```{r}
library(vegan)

# Species richness per site
richness <- rowSums(pa_matrix > 0)

# Shannon diversity
shannon <- diversity(abundance_matrix, index = "shannon")

# Simpson diversity
simpson <- diversity(abundance_matrix, index = "simpson")

# Combine into summary
diversity_df <- data.frame(
  station_id = rownames(abundance_matrix),
  richness = richness,
  shannon = shannon,
  simpson = simpson
)
```

### Ordination

```{r}
# NMDS ordination
nmds <- metaMDS(abundance_matrix, distance = "bray", k = 2)

# Extract scores
nmds_scores <- as.data.frame(scores(nmds))
nmds_scores$station <- rownames(nmds_scores)

# Plot
ggplot(nmds_scores, aes(x = NMDS1, y = NMDS2, label = station)) +
  geom_point(size = 3) +
  geom_text(vjust = -1) +
  labs(title = "NMDS Ordination of Station Communities") +
  theme_minimal()
```

## Spatial Analysis

```{r}
library(sf)

# Convert detections to spatial object
detections_sf <- st_as_sf(
  detections,
  coords = c("longitude", "latitude"),
  crs = 4326
)

# Map stations
stations_sf <- st_as_sf(
  my_stations,
  coords = c("longitude", "latitude"),
  crs = 4326
)

# Plot with tmap
library(tmap)
tm_shape(stations_sf) +
  tm_dots(size = 0.5, col = "red") +
  tm_layout(title = "BirdWeather Stations")
```

## Exporting Data

```{r}
# Export to CSV
write.csv(detections, "birdweather_detections.csv", row.names = FALSE)

# Export species summary
write.csv(species_summary, "species_summary.csv", row.names = FALSE)

# Save as RDS for later use
saveRDS(detections, "detections.rds")
```

## Tips and Best Practices

1. **Start with small date ranges** when first exploring a station's data
2. **Use min_confidence** to filter out uncertain detections (0.8 is a good threshold)
3. **Cache downloaded data** - API calls can take time for large datasets
4. **Check for timezone** issues - timestamps are in the station's local timezone
5. **Respect API limits** - the package handles pagination, but very large queries may take time

## Next Steps

- Combine BirdWeather data with eBird data using the `auk` or `rebird` packages
- Integrate with weather data for phenology studies
- Use `movebank` package to combine with animal tracking data
- Apply occupancy models using `unmarked` package

## Getting Help

- Package documentation: `?birdweather`
- Function help: `?bw_get_detections`
- Report issues: https://github.com/yourusername/birdweather/issues
- BirdWeather documentation: https://birdweather.com/docs
